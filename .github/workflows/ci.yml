name: MERN CI  # ğŸ‘ˆ Workflow name shown in GitHub Actions tab

on:
  push:
    branches: [main]  # ğŸ‘ˆ Runs this workflow only when code is pushed to 'main' branch

jobs:
  mongo-init-test:
    runs-on: ubuntu-latest  # ğŸ‘ˆ Uses latest Ubuntu runner as the build environment
    
    env:
      PORT: ${{ secrets.PORT }}          # ğŸ‘ˆ Securely loads environment variables from GitHub Secrets
      MONGO_URI: ${{ secrets.MONGO_URI }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}

    services:
      mongo:  # ğŸ‘ˆ Starts a MongoDB service container for testing
        image: mongo  # ğŸ‘ˆ Uses the official MongoDB Docker image
        ports: ['27017:27017']  # ğŸ‘ˆ Exposes MongoDB default port so the app can connect
    
    steps:
      - name: Checkout Repository  # ğŸ‘ˆ Step 1: Pulls repository code into the runner
        uses: actions/checkout@v5  # ğŸ‘ˆ Official GitHub Action for checking out code

      - name: Setup Node.js  # ğŸ‘ˆ Step 2: Prepares Node.js environment
        uses: actions/setup-node@v3
        with:
          node-version: '18'  # ğŸ‘ˆ Specifies Node.js version compatible with your MERN stack

      - name: Waiting for MongoDB to be ready  # ğŸ‘ˆ Step 3: Ensures MongoDB container is ready before proceeding
        run: |
          until nc -z localhost 27017; do
            echo "Waiting for MongoDB..."
            sleep 5
          done
          echo "âœ… MongoDB is up and running"

      - name: Install Dependencies  # ğŸ‘ˆ Step 4: Installs project dependencies cleanly
        working-directory: ./backend  # ğŸ‘ˆ Targets backend folder for install, Skips funding/audit messages to keep logs clean
        run: |
          npm install --no-fund --no-audit

      - name: Check for Deprecated Packages  # ğŸ‘ˆ Step 5: Checks and lists outdated/deprecated packages and Lists deprecated packages but doesnâ€™t fail the CI
        working-directory: ./backend
        run: |
          echo "ğŸ” Checking for deprecated npm packages..."
          npx npm-check-updates -d

      - name: Seed MongoDB  # ğŸ‘ˆ Step 6: Populates DB with sample/test data
        working-directory: ./backend
        run: |
          node seedTasksData.js

      - name: Running Backend Tests  # ğŸ‘ˆ Step 7: Executes backend test suite
        working-directory: ./backend
        run: npm test  # ğŸ‘ˆ Runs tests defined in package.json
